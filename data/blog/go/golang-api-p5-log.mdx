---
title: 'API Service with Go: Logging'
date: '2022-02-05'
lastmod: '2022-04-20'
tags: ['api', 'go', 'log']
draft: false
summary: '‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á log ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£'
---

# Logging

‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á log ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á transaction_id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ log ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å request ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å

## Transaction Id

‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á log ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤ log ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á transcation ‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ö‡πâ‡∏≤‡∏á ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏Ñ‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ unique id ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô log ‡∏î‡πâ‡∏ß‡∏¢

```go:handler/handler.go
if err := tx.Error; err != nil {
	appErr := errs.NewUnexpectedError(err.Error())
	if errors.Is(err, gorm.ErrRecordNotFound) {
		appErr = errs.NewNotFoundError("todo with given id not found")
	}
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á x-trasaction-id ‡πÄ‡∏õ‡πá‡∏ô uuid ‡∏°‡∏≤‡πÉ‡∏ô request header
  txId := r.Header.Get("x-transaction-id")
	log.Println(txId, appErr.Message)
	w.Header().Add("Content-Type", "application/json")
	w.WriteHeader(appErr.Code)
	json.NewEncoder(w).Encode(appErr)
	return
}

// 2022/02/01 11:07:10 833d57ef-afb9-45c1-8450-9eff6559043e todo with given id not found
```

## Structured Logging

‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á `log.Println()` ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á log ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á JSON ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô

```go
2022/02/01 11:07:10 833d57ef-afb9-45c1-8450-9eff6559043e todo with given id not found

‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô

{
  "timestamp": "2022/02/01 11:07:10",
  "transactionId": "833d57ef-afb9-45c1-8450-9eff6559043e",
  "message": "todo with given id not found"
}
```

‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏°‡∏µ package ‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà 2 ‡∏ï‡∏±‡∏ß ‡∏Ñ‡∏∑‡∏≠ [zap](https://github.com/uber-go/zap) ‡∏Å‡∏±‡∏ö [logrus](https://github.com/sirupsen/logrus) ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ zap

```bash
go get -u go.uber.org/zap
```

‡∏™‡∏£‡πâ‡∏≤‡∏á logger module

```go:logger/logger.go
package logger

import (
	"fmt"

	"go.uber.org/zap"
)

var log *zap.Logger

func init() {
	fmt.Println("init log")
	var err error

	log, err = zap.NewProduction()

	if err != nil {
		panic(err)
	}
}

func Info(message string, fileds ...zap.Field) {
	log.Info(message, fileds...)
}

func Debug(message string, fileds ...zap.Field) {
	log.Debug(message, fileds...)
}

func Error(message string, fileds ...zap.Field) {
	log.Error(message, fileds...)
}
```

‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

```go:main.go
// main.go
func main() {
  // ...
  logger.Info("Starting server at port 8080")
	log.Fatal(http.ListenAndServe(":8080", handler))
}

// {"level":"info","ts":1643702027.675124,"caller":"logger/logger.go:20","msg":"Starting server at port 8080"}
```

<aside>
üí° ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà caller ‡∏ô‡∏±‡πà‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢ `zap.NewProduction(zap.AddCallerSkip(1))` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô log ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

</aside>

```go:logger/logger.go
func init() {
	var err error

	log, err = zap.NewProduction(zap.AddCallerSkip(1))

	if err != nil {
		panic(err)
	}
}
```

‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ field ‡πÄ‡∏ä‡πà‡∏ô ts ‡πÄ‡∏õ‡πá‡∏ô timestamp ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô format ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ

```go:logger/logger.go
func init() {
	var err error

	encoderConfig := zap.NewProductionEncoderConfig()
	encoderConfig.TimeKey = "timestamp"
	encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder

	config := zap.NewProductionConfig()
	config.EncoderConfig = encoderConfig

	log, err = config.Build(zap.AddCallerSkip(1))

	if err != nil {
		panic(err)
	}
}
// {"level":"info","timestamp":"2022-02-01T15:04:40.736+0700","caller":"goapi/main.go:39","msg":"Starting server at port 8080"}
```

<aside>
üí° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á key ‡πÑ‡∏´‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà `= ""` ‡πÄ‡∏ä‡πà‡∏ô `encoderConfig.StacktraceKey = ""`

</aside>

### ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ Elastic Search

‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å log ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Elastic Search ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ format ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏±‡πâ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö plugin ECS loggers

‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á `go get go.elastic.co/ecszap`

```go:logger/logger.go
func init() {
	var err error

	config := zap.NewProductionConfig()
	config.EncoderConfig = ecszap.ECSCompatibleEncoderConfig(config.EncoderConfig)
	log, err = config.Build(ecszap.WrapCoreOption(), zap.AddCallerSkip(1))

	if err != nil {
		panic(err)
	}
}
```

### Dev Mode

‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á log ‡πÅ‡∏ö‡∏ö json ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö Development Config ‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ

```go:logger/logger.go
func init() {
	var err error
	mode := os.Getenv("APP_ENV")
	var config zap.Config
	if mode == "production" {
		config = zap.NewProductionConfig()
	} else {
		config = zap.NewDevelopmentConfig()
	}
	config.EncoderConfig = ecszap.ECSCompatibleEncoderConfig(config.EncoderConfig)
	log, err = config.Build(ecszap.WrapCoreOption(), zap.AddCallerSkip(1))

	if err != nil {
		panic(err)
	}
}
```

### ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° transactionId

‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° transactionId ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ `zap.String("transactionId", txId)` ‡∏™‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á message ‡πÄ‡∏ä‡πà‡∏ô

```go
if err := tx.Error; err != nil {
	appErr := errs.NewUnexpectedError(err.Error())
	if errors.Is(err, gorm.ErrRecordNotFound) {
		appErr = errs.NewNotFoundError("todo with given id not found")
	}
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á x-trasaction-id ‡πÄ‡∏õ‡πá‡∏ô uuid ‡∏°‡∏≤‡πÉ‡∏ô request header
  txId := r.Header.Get("x-transaction-id")

	log.Error(appErr.Message, zap.String("transactionId", txId))

	w.Header().Add("Content-Type", "application/json")
	w.WriteHeader(appErr.Code)
	json.NewEncoder(w).Encode(appErr)
	return
}
```
