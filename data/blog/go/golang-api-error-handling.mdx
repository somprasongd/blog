---
title: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error ‡πÉ‡∏ô Rest API'
date: '2025-02-06'
tags: ['go', 'api', 'error']
draft: false
summary: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error ‡πÉ‡∏ô Rest API ‡πÅ‡∏ö‡∏ö 3-layer architecture'
---

# ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error ‡πÉ‡∏ô Rest API ‡πÅ‡∏ö‡∏ö 3-layer architecture

‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ Rest API ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÅ‡∏ö‡∏ö 3-layer architecture ‡πÄ‡∏ä‡πà‡∏ô Handler ‚Üí Service ‚Üí Repository ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÑ‡∏õ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á error ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ layer ‡∏Å‡πà‡∏≠‡∏ô ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ

1. **Repository Layer:**
   - ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ wrap database error ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢
   - ‡∏´‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ return custom error ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô ErrDataIntegrity ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ Foreign key, constraint violations ‡∏´‡∏£‡∏∑‡∏≠ ErrDuplicateEntry ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ Conflict
2. **Service Layer:**
   - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ validate input ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á repository errors ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô business errors
   - ‡πÉ‡∏´‡πâ log unexpected errors ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ debug
3. **Handler Layer:**
   - ‡πÅ‡∏õ‡∏•‡∏á service errors ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô HTTP response ‡πÄ‡∏ä‡πà‡∏ô HTTP 400, 404, 500

‡∏ñ‡∏±‡∏î‡∏°‡∏≤‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ error ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô

| **Error Type**       | **HTTP Status**             | **When It Happens?**                                                             |
| -------------------- | --------------------------- | -------------------------------------------------------------------------------- |
| ErrInvalidRequest    | `400 Bad Request`           | Invalid/malformed request (e.g., missing required fields, invalid format)        |
| ErrValidation        | `422 Unprocessable`         | When request data is structurally valid but violates business rules              |
| ErrAuthentication    | `401 Unauthorized`          | Missing or invalid authentication token                                          |
| ErrAuthorization     | `403 Forbidden`             | User does not have permission to access a resource                               |
| ErrResourceNotFound  | `404 Not Found`             | Resource not found (e.g., user, order, product doesn't exist)                    |
| ErrDuplicateEntry    | `409 Conflict`              | Conflict with existing resource (e.g., duplicate email, order already processed) |
| ErrBusinessLogic     | `422 Unprocessable`         | Failed logical validation (e.g., insufficient funds)                             |
| ErrTooManyRequests   | `429 Too Many Requests`     | Rate-limiting (too many API requests in a short time)                            |
| ErrDatabaseFailure   | `500 Internal Server Error` | Database connection failure, SQL error, or transaction failure                   |
| ErrDataIntegrity     | `500 Internal Server Error` | Database-related issues: Foreign key, constraint violations                      |
| ErrServiceDependency | `503 Service Unavailable`   | External service failure                                                         |
| ErrOperationFailed   | `500 Internal Server Error` | Unknown errors                                                                   |

‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢ ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤ Go ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á

### Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Custom errors

‡∏™‡∏£‡πâ‡∏≤‡∏á custom error struct ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ ‡πÇ‡∏î‡∏¢‡∏°‡∏µ error type ‡πÅ‡∏•‡∏∞ message

```go
// file: util/errs/errs.go
package errs

// ErrorType defines a type for different error categories in the service layer
type ErrorType string

const (
 // Input and Request Issues
 ErrInvalidRequest ErrorType = "invalid_request"  // Malformed JSON, missing/invalid fields
 ErrValidation     ErrorType = "validation_error" // Field-level validation (business rules)

 // Authentication and Authorization
 ErrAuthentication ErrorType = "authentication_error" // Invalid credentials
 ErrAuthorization  ErrorType = "authorization_error"  // Permission denied

 // Resource State Issues
 ErrResourceNotFound ErrorType = "resource_not_found"   // Missing entity
 ErrDuplicateEntry   ErrorType = "duplicate_entry"      // Conflict (e.g., unique constraint)
 ErrBusinessLogic    ErrorType = "business_logic_error" // Violations of business rules

 // Infrastructure and General Failures
 ErrDataIntegrity     ErrorType = "data_integrity_error" // Foreign key, constraint violations
 ErrDatabaseFailure   ErrorType = "database_failure"     // DB-level errors
 ErrServiceDependency ErrorType = "service_dependency"   // External service unavailability
 ErrOperationFailed   ErrorType = "operation_failed"     // Generic internal failures
)

// AppError represents a structured error used in the service layer
type AppError struct {
 Type       ErrorType      `json:"type"`        // Error category
 Message    string         `json:"message"`     // Friendly message for clients
}

// Error implements the error interface
func (e *AppError) Error() string {
 return fmt.Sprintf("[%s] %s", e.Type, e.Message)
}

// NewAppError creates a new AppError
func NewAppError(typ ErrorType, message string) *AppError {
 return &AppError{
  Type:       typ,
  Message:    message,
 }
}

// GetErrorType extracts the error type from an error
func GetErrorType(err error) ErrorType {
 if appErr, ok := err.(*AppError); ok {
  return appErr.Type
 }
 return ErrOperationFailed // Default error type if not recognized
}
```

### Step 2: Repository Layer

- Wrap database errors
- Return `ErrDuplicateEntry` ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà email ‡∏ã‡πâ‡∏≥

```go
// file: repository/customer.go
package repository

import (
 "context"
 "database/sql"
 "fmt"
 "time"

 "github.com/lib/pq"

 "my-app/models"
)

type UserRepository struct {
 db *sql.DB
}

func NewUserRepository(db *sql.DB) *UserRepository {
 return &UserRepository{db *sql.DB}
}

func (r *UserRepository) Create(ctx context.Context, user *models.User) error {
 query := `INSERT INTO public.users (email, name) VALUES ($1, $2) RETURING id`

 err := r.db.QueryRowContext(ctx, query, user.Email, user.Name).
 Scan(&user.ID)
 if err != nil {
  // Detect duplicate entry (Postgres unique_violation code: 23505)
  if pqErr, ok := err.(*pq.Error); ok {
   if pqErr.Code == "23505" {
    return NewAppError(ErrDuplicateEntry, "email already registered")
   }
  }
  // Wrap database error
  return fmt.Errorf("failed to create user: %w", err)
 }

 return nil
}

```

### Step 3: Service Layer

- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ validate input
- ‡πÅ‡∏õ‡∏•‡∏á repository errors ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô business errors
- ‡πÉ‡∏´‡πâ log unexpected errors ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ debug

```go
// service/user.go
package service

import (
 "context"
 "log"
 "my-app/dtos"
 "my-app/models"
 "my-app/repository"
 "my-app/util/errs"
)

type UserService struct {
 userRepo *repository.UserRepository
}

func NewOrderService(userRepo repository.UserRepository) *UserService {
 return &UserService{userRepo: userRepo}
}

func (s *UserService) CreateUser(ctx context.Context, req *dtos.User) (int, error) {
  // validation input
 if req.Email == "" {
  return errs.NewAppError(errors.ErrValidation, "email is required")
 }

 user := &models.User{
  Email: req.Email,
  Name:  req.Name,
 }

 err := s.userRepo.Create(ctx, user)
 if err != nil {
  // log unexpected error
  log.Println(err)
  // handle repository error
  if ErrDuplicateEntry == errs.GetErrorType(err) {
   return err
  }
  return errs.NewAppErr(ErrDatabaseFailure, "failed to create user")
 }

 return user.ID, nil
}

```

### Step 4: Handler Layer

- ‡πÅ‡∏õ‡∏•‡∏á service errors ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô HTTP response

```go
// file: handler/user.go
package handler

import (
 "github.com/gin-gonic/gin"
 "my-app/service"
 "my-app/dtos"
 "my-app/util/errs"
 "net/http"
)

type UserHandler struct {
 service *service.UserService
}

func NewUserHandler(srv service.UserService) *UserHandler{
 return &UserHandler{service: srv}
}

func (h *UserHandler) CreateUser(c *gin.Context) {
 var user dtos.User
 if err := c.ShouldBindJSON(&user); err != nil {
  // Invalid JSON format error
  h.handleError(c, errs.NewAppError(errors.ErrJSONParse, "invalid JSON format"))
  return
 }

 id, err := h.service.CreateUser(c.Request.Context(), &user)

 if err != nil {
  // Handle business validation error
  handleError(c, err)
  return
 }

 c.JSON(http.StatusCreated, gin.H{"id": id})
}

```

- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleError ‡πÑ‡∏ß‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error response

```go
// file: handler/handler.go
package handler

import (
 "github.com/gin-gonic/gin"
 "my-app/util/errs"
)

type errorResponse struct {
 ErrorType    errs.ErrorType `json:"error_type"`
 ErrorMessage string         `json:"error_message"`
}

// Centralized error handling
func (h *CustomerHandler) handleError(c *gin.Context, err error) {
 // Convert non-AppError to AppError with type ErrOperationFailed
 appErr, ok := err.(*errs.AppError);
 if !ok {
  appErr = errors.NewAppError(errs.ErrOperationFailed, err.Error())
 }

 // Get the appropriate HTTP status code based on the error type
 statusCode := errs.GetHTTPStatus(err)

 // Return the error in structured JSON format
 c.JSON(statusCode, errorResponse{
  ErrorType:    appErr.Type,
  ErrorMessage: appErr.Message,
 })
}

```

‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Layer

- **Repository Layer**: ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- **Service Layer**: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Validation ‡πÅ‡∏•‡∏∞ Bussiness Login
- **Handler Layer**: ‡πÅ‡∏õ‡∏•‡∏á Error ‡πÄ‡∏õ‡πá‡∏ô JSON Response ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°

**‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå:**

- ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô (DRY Principle)
- ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Layer ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°

### üéØ ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°

- ‚úÖ **‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Error ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô** ‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó (Validation, Business, Database, External)
- ‚úÖ **‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTTP Status Code ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á** ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô REST API
- ‚úÖ **‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î** ‡∏î‡πâ‡∏ß‡∏¢ PostgreSQL Error Code
- ‚úÖ **‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô** ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ `AppError` ‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å Layer
- ‚úÖ **‡∏Ç‡∏¢‡∏≤‡∏¢‡∏á‡πà‡∏≤‡∏¢** ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà ‡πÜ ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏µ‡∏¢‡∏á `ErrorType`
- ‚úÖ **‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô** ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Error ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
