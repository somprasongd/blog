---
title: '‡∏ó‡∏≥ Authentication ‡∏î‡πâ‡∏ß‡∏¢ Nginx auth_request ‡πÇ‡∏°‡∏î‡∏π‡∏•'
date: '2022-08-23'
lastmod: '2022-08-23'
tags: ['authentication', 'nginx', 'nodejs']
draft: false
summary: '‡πÉ‡∏ä‡πâ Nginx ‡∏™‡∏£‡πâ‡∏≤‡∏á HTTP subrequest ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á auth server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Authentication'
---

# ‡∏ó‡∏≥ Authentication ‡∏î‡πâ‡∏ß‡∏¢ Nginx auth_request ‡πÇ‡∏°‡∏î‡∏π‡∏•

‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏°‡∏µ auth server ‡πÅ‡∏•‡∏∞ resource server ‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á resource server ‡∏ô‡∏±‡πâ‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô ‡∏Ñ‡∏∑‡∏≠ ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ authentication ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ resource server ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏¢‡∏±‡∏á auth server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏á ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ

<div className="flex justify-center">
  <div>![hexagonal](/static/images/server/nginx-auth-req-1.png)</div>
</div>

‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ Nginx ‡πÄ‡∏õ‡πá‡∏ô reverse proxy ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡∏î‡∏π‡∏• auth_request ‡∏Ç‡∏≠‡∏á Nginx ‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Authentication ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô

<div className="flex justify-center">
  <div>![hexagonal](/static/images/server/nginx-auth-req-2.png)</div>
</div>

## ‡πÇ‡∏°‡∏î‡∏π‡∏• auth_request

‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏∑‡∏≠ ‡∏°‡∏±‡∏ô‡∏°‡∏µ request ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏¢‡∏±‡∏á location ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ Nginx ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á HTTP subrequest ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á auth server ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ directives 2 ‡∏ï‡∏±‡∏ß ‡∏Ñ‡∏∑‡∏≠

- **auth_request** - ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏ URI ‡∏Ç‡∏≠‡∏á subrequest
- **auth_request_set** - ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á request variable ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà authentication ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ `$upstream_http_*`

‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ auth server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å HTTP response code ‡∏Ç‡∏≠‡∏á subrequest ‡∏ô‡∏±‡πâ‡∏ô ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ

- `2xx` - ‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á request ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÑ‡∏î‡πâ
- `401, 403` - ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á request ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô 500 Internal Server Error ‡πÅ‡∏ó‡∏ô

## ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

1. ‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏ä‡πâ Nginx ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Open Source ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏°‡∏î‡∏π‡∏• `with-http_auth_request_module` ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ

```bash
nginx -V 2>&1 | grep -- 'http_auth_request_module'
```

‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ `--with-http_auth_request_module` ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

2. ‡∏™‡∏£‡πâ‡∏≤‡∏á subrequest ‡πÉ‡∏ô request ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ authentication ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ directive [auth_request](https://nginx.org/en/docs/http/ngx_http_auth_request_module.html?&_ga=2.139716662.484507117.1660694845-1805296998.1660549266#auth_request)

```
location /private/ {
  auth_request /auth;
  #...
}
```

‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà `/private` ‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á subrequest ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà `/auth` location

3. ‡∏™‡∏£‡πâ‡∏≤‡∏á `/auth` ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô internal location ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ directive [proxy_pass](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á authentication server ‡∏´‡∏£‡∏∑‡∏≠ service ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤

```
location = /auth {
  internal;
  proxy_pass http://auth-server;
  #...
}
```

4. ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å default ‡∏à‡∏∞ proxy_pass ‡πÑ‡∏õ‡∏¢‡∏±‡∏á [http://auth-server](http://auth-server) ‡∏î‡πâ‡∏ß‡∏¢ method `GET` ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ request body ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ authentication ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ directive [proxy_pass_request_body](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass_request_body) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô off ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ Content-Length ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á

```
location = /auth {
  internal;
  proxy_pass              http://auth-server;
  proxy_pass_request_body off;
  proxy_set_header        Content-Length "";
  #...
}
```

  <aside>
üí° Default ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏ö‡∏ö GET ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô POST ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°  `proxy_method POST;` ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô `proxy_pass`

  </aside>

5. ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á original request URI ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ó‡∏≥ authorization ‡∏ß‡πà‡∏≤ user ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô url ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ directive [proxy_set_header](https://nginx.org/en/docs/http/ngx_http_proxy_module.html?&_ga=2.169551780.484507117.1660694845-1805296998.1660549266#proxy_set_header)

```
location = /auth {
  internal;
  proxy_pass              http://auth-server;
  proxy_pass_request_body off;
  proxy_set_header        Content-Length "";
  proxy_set_header        X-Original-URI $request_uri;
}
```

6. ‡πÄ‡∏°‡∏∑‡πà‡∏≠ authen ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á request ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ directive [auth_request_set](https://nginx.org/en/docs/http/ngx_http_auth_request_module.html#auth_request_set) ‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á username ‡πÑ‡∏õ

```
location /private/ {
  auth_request        /auth;
  # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡∏°‡πà
  auth_request_set $auth_user $upstream_auth_user;
  # ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ó‡∏≤‡∏á header
  proxy_set_header  X-User $auth_user;
}
```

## ‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á

‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏°‡∏µ auth server ‡πÅ‡∏•‡∏∞ resource server ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ

- **auth server** ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ signin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á token ‡πÅ‡∏•‡∏∞ verify token
  ```jsx
  const app = express()
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á jwt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin ‡∏´‡∏£‡∏∑‡∏≠ user
  app.post('/api/auth/signin', (req, res) => {
    const isAdmin = req.query.isAdmin === 'true'
    const token = jwt.sign(
      {
        id: 1,
        username: isAdmin ? 'admin' : 'user',
        isAdmin,
      },
      secret
    )
    res.json({ token })
  })
  // ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö jwt ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡πÄ‡∏õ‡πá‡∏ô base64 ‡πÑ‡∏õ‡∏ó‡∏≤‡∏á X-Id-Token
  app.get('/api/auth/verify', (req, res) => {
    const token = req.headers.authorization ? req.headers.authorization.split(' ') : undefined
    if (!token || token.length < 2) return res.sendStatus(401)
    const user = jwt.verify(token[1], secret)
    res.set('X-Id-Token', Buffer.from(JSON.stringify(user)).toString('base64'))
    res.sendStatus(200)
  })
  ```
- **resource server** ‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏≤ user ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ authen ‡∏ú‡πà‡∏≤‡∏ô Nginx ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏±‡∏ö `X-Id-Token`

  ```jsx
  const app = express()
  // ‡πÉ‡∏ä‡πâ middleware ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ decode ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user
  app.use((req, res, next) => {
    const idToken = req.headers['x-id-token']
    if (!idToken) return res.sendStatus(401)
    const decoded = Buffer.from(idToken, 'base64').toString('ascii')
    const user = JSON.parse(decoded)
    req.user = user
    next()
  })
  // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ role admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  app.get('/api/resource/admin', (req, res) => {
    const user = req.user
    if (!user.isAdmin) return res.sendStatus(403)
    res.json({ message: `User "${user.username}" can access admin` })
  })

  app.get('/api/resource/private', (req, res) => {
    const user = req.user
    res.json({ message: `User "${user.username}" can access private` })
  })
  ```

‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô nginx config ‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ

```
upstream auth-api {
  server auth:3000;
}

upstream private-api {
  server private:3002;
}

server {
  listen       80;
  listen  [::]:80;
  server_name  _;

  # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ path verify ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÑ‡∏î‡πâ
  location ~ /api/auth/verify {
    deny all; # ‡∏à‡∏∞ return 403 ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
  }

	# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö signin
  location ~ ^/(api/auth) {
    proxy_pass http://auth-api;

    proxy_redirect off;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header Host $http_host; # proxy_set_header  Host $host;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
  }

  # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö auth_request
  location /auth-verify {
    internal;

    proxy_pass        http://auth-api/api/auth/verify;

    proxy_redirect    off;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
  }

  # ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á subrequest ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á /auth-verify
  location ~ ^/(api/resource) {
    auth_request /auth-verify;
    # ‡πÄ‡∏≠‡∏≤ x-id-token ‡∏à‡∏≤‡∏Å subrequest ‡∏°‡∏≤‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
    auth_request_set $x_id_token $upstream_http_x_id_token;

    proxy_pass http://private-api;

    proxy_redirect off;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header Host $http_host; # proxy_set_header  Host $host;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Id-Token $x_id_token; # ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Å‡∏±‡∏ö Header
  }

}
```

‡∏ó‡∏î‡∏™‡∏≠‡∏ö

```bash
$ curl -XPOST \
'http://localhost:8800/api/signin'

{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJ1c2VyIiwiaXNBZG1pbiI6ZmFsc2UsImlhdCI6MTY2MTE3Nzg5NX0.rgcxfF00ck6zzYl4clNJBSPnDgrMVRYdlfl6E11nUKU"}

$ curl -XGET \
'http://localhost:8800/api/resource/private' \
-H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJ1c2VyIiwiaXNBZG1pbiI6ZmFsc2UsImlhdCI6MTY2MTE3Nzg5NX0.rgcxfF00ck6zzYl4clNJBSPnDgrMVRYdlfl6E11nUKU"

{"message":"User \"user\" can access private"}
```

‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥ authentication ‡∏ú‡πà‡∏≤‡∏ô nginx ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß

## ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error

‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏°‡∏î‡∏π‡∏• auth_request ‡∏ñ‡πâ‡∏≤ auth server ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á status code ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô 2xx ‡∏ï‡∏±‡∏ß nginx ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á error ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤ auth server ‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πá‡∏ï‡∏≤‡∏°

```bash
$ curl -XGET \
'http://localhost:8800/api/resource/private' \
-H "Authorization: Bearer invalid_token"

<html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.23.1</center>
</body>
</html>
```

‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ

```diff
server {

+ location @errorAuth401 {
+   default_type application/json;
+   return 401 '{"status":"401","error":{"code": 401,"message": "the token is invalid or expired"}}';
+ }

+ location @errorAuth403 {
+   default_type application/json;
+   return 403 '{"status":"403","error":{"code": 403,"message": "forbidden"}}';
+ }

+ location @errorAuth500 {
+   default_type application/json;
+   return 403 '{"status":"500","error":{"code": 500,"message": "unexpected error"}}';
+ }

  # ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á subrequest ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á /auth-verify
  location ~ ^/(api/resource) {
    auth_request /auth-verify;

+   # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error
+   error_page 401 = @errorAuth401;
+   error_page 403 = @errorAuth403;
+   error_page 500 = @errorAuth500;

    # ‡πÄ‡∏≠‡∏≤ x-id-token ‡∏à‡∏≤‡∏Å subrequest ‡∏°‡∏≤‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
    auth_request_set $x_id_token $upstream_http_x_id_token;

    proxy_pass http://private-api;

    proxy_redirect off;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header Host $http_host; # proxy_set_header  Host $host;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Id-Token $x_id_token; # ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Å‡∏±‡∏ö Header
  }

}
```

‡∏ó‡∏î‡∏™‡∏≠‡∏ö error

```bash
$ curl -XGET \
'http://localhost:8800/api/resource/private' \
-H "Authorization: Bearer invalid_token"

{"status":"401","error":{"code": 401,"message": "the token is invalid or expired"}}
```

## ‡∏™‡∏£‡∏∏‡∏õ

‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡∏î‡∏π‡∏• auth_request ‡∏ô‡∏±‡πâ‡∏ô ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á auth server ‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ resource server ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ‡∏ã‡∏∂‡πà‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ authorization ‡∏Å‡πá‡∏ó‡∏≥‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á url ‡∏Ç‡∏≠‡∏á request ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏Ñ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö permission ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å resource server ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏î‡πâ‡∏ß‡∏¢

‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ[‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà](https://github.com/somprasongd/blog-code/tree/main/nginx/nginx_auth_request)
